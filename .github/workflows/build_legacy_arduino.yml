name: Build Digifiz Replica Arduino
on: 
 - push
 - pull_request
jobs:
  compile-sketch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      # --- Backup Original setup.h ---
      - name: Backup Original setup.h
        run: mv A2560_BoardR2/Digifiz/setup.h A2560_BoardR2/Digifiz/setup.h.orig

      # --- Define Variants ---
      - name: Set Variant List
        run: echo "VARIANTS=setup_audi_red setup_audi_green setup_g2 setup_g2_uk setup_g2_usa setup_g2_diesel" >> $GITHUB_ENV

      # --- Install Dependencies (Arduino Libraries) ---
      - name: Install Required Arduino Libraries
        run: |
          arduino-cli lib install --git-url https://github.com/sparkfun/SparkFun_External_EEPROM_Arduino_Library.git
          arduino-cli lib install "RTCLib"
          arduino-cli lib install --git-url https://github.com/adafruit/Adafruit_BusIO.git
          arduino-cli lib install "MedianFilterLib2"

      # --- Loop and Build Each Variant ---
      - name: Compile All Variants
        run: |
          for VARIANT in $VARIANTS; do
            echo "Building $VARIANT..."
            cp A2560_BoardR2/Digifiz/${VARIANT}.h A2560_BoardR2/Digifiz/setup.h
            arduino-cli compile --fqbn arduino:avr:mega A2560_BoardR2/Digifiz/ --output-dir build/$VARIANT
            mv A2560_BoardR2/Digifiz/setup.h.orig A2560_BoardR2/Digifiz/setup.h  # Restore
          done

      # --- Upload All Arduino Variants as Artifacts ---
      - name: Collect Arduino Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: digifiz-firmware
          path: build/
          compression-level: 0  # Adjust for speed vs. size (0 = fastest, 9 = smallest)
          if-no-files-found: error  # Fails if no firmware is generated